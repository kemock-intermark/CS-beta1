# Техническая спецификация ClubSuite

## Стратегический и технический план интеграции приложения в экосистему Telegram

### Часть 1: Стратегические и архитектурные основы

#### Раздел 1: Экосистема Telegram: анализ двухплатформенной модели

##### 1.1 Определение ролей: разговорный и прикладной уровни

**Telegram боты (разговорный уровень):** Автоматизированные программы с текстовым, командно-ориентированным интерфейсом через Telegram Bot API.

**Telegram Mini Apps (прикладной уровень):** Полноценные веб-приложения (HTML, CSS, JavaScript) в WebView внутри Telegram, связанные с ботом как точкой входа.

##### 1.2 Сравнительный анализ

| Характеристика | Telegram Bot | Telegram Mini App | Стратегическое значение |
|----------------|--------------|-------------------|-------------------------|
| UI/UX | Текст, команды, кнопки | Полноценный графический интерфейс | Mini App для основного UX, бот для быстрых действий |
| Сложность разработки | Низкая | Высокая | Распределение ресурсов соответственно |
| Функциональность | Автоматизация, уведомления | Любая веб-функциональность | Промоутерские команды в боте, основной функционал в Mini App |
| Аутентификация | Простая (user_id) | initData с верификацией | Бот для первичной auth, Mini App для сессий |
| Монетизация | Ограниченная | Широкие возможности | Mini App для платежей |

##### 1.3 Гибридный императив

Интегрированный подход:
- Бот = легковесная "входная дверь" и механизм уведомлений
- Mini App = основной иммерсивный опыт

#### Раздел 2: Архитектурный план

##### 2.1 Компоненты системы
1. Клиент пользователя (Telegram)
2. Серверы Telegram
3. Бэкенд бота
4. Фронтенд Mini App (SPA)
5. Основной бэкенд приложения

##### 2.2 Модель "входной двери": бот как шлюз
- Онбординг через /start
- Аутентификация (telegram_id → аккаунт)
- Push-уведомления
- Маршрутизация в Mini App

##### 2.3 Модель "ядра": Mini App как основной UX
- Telegram Web App SDK
- Адаптивная темизация
- Безопасное API взаимодействие через initData

##### 2.4 Потоки данных
- User → Bot: команды через Webhook
- Bot → User: ответы через Bot API
- User → Mini App: WebView с initData
- Mini App ↔ Backend: REST/GraphQL с JWT
- Backend → Bot → User: уведомления

### Часть 2: Лучшие практики разработки

#### Раздел 3: Бот для промоутера

##### 3.1 Дизайн команд
- Короткие, специфичные команды (/generatelink, /myguests)
- ReplyKeyboardMarkup для основных действий
- InlineKeyboardMarkup для контекстных действий

##### 3.2 Webhooks (обязательно)
- HTTPS endpoint
- Быстрый ответ 200 OK
- Асинхронная обработка

##### 3.3 Безопасность
- Токен в переменных окружения
- Валидация всех входных данных
- Использование проверенных SDK

#### Раздел 4: Mini App

##### 4.1 UI/UX
- Mobile-first дизайн
- Динамическая темизация через themeParams
- Оптимизация производительности

##### 4.2 Технологический стек

| Компонент | Рекомендация | Обоснование |
|-----------|--------------|-------------|
| Фронтенд | React/Vue с Vite | Стандарты индустрии |
| SDK | tma.js | TypeScript, лучшая документация |
| UI | Konsta UI | Нативный вид Telegram |
| Хостинг | Vercel/Netlify | CDN, SSL, автодеплой |

##### 4.3 Интеграция с Telegram
- Бесшовная авторизация через initData
- Управление MainButton и BackButton
- Метод sendData() для связи с ботом

### Часть 3: Система "Промоутер-Гость"

#### Раздел 5: Рабочий процесс промоутера

##### 5.1 Deep-ссылки
Формат: `t.me/<bot_username>?start=<payload>`

Процесс:
1. Промоутер: /generatelink
2. Backend: создает UUID токен в Redis (TTL 24h)
3. Bot: отправляет ссылку промоутеру
4. Промоутер: делится с гостем

##### 5.2 Команды промоутера

| Команда | Описание | Backend действие |
|---------|----------|------------------|
| /generatelink | Создать приглашение | Генерация токена |
| /myguests | Список гостей | Запрос связанных users |
| /broadcast | Рассылка | Массовая отправка |
| /stats | Статистика | Агрегированные KPI |

#### Раздел 6: Путь гостя

##### 6.1 Поток аутентификации
1. Гость: клик по deep-ссылке
2. Telegram: /start <token>
3. Backend: валидация токена
4. Создание аккаунта с привязкой к промоутеру
5. Bot: приветствие + кнопка Mini App

##### 6.2 Передача в Mini App
1. Открытие Mini App
2. Получение initData
3. Верификация на backend
4. Создание JWT сессии

### Часть 4: MVP Техническое задание

## 1. Цели и охват

**Цель:** Запустить платформу управления клубами в Telegram

**Ключевые процессы:**
- Листы гостей/билеты/QR-чекин
- Бронирование столов и пакетов с депозитами
- CRM гостя (VIP-уровни, история)
- Промоутерский контур
- Маркетинг и waitlist
- Отчётность

## 2. Роли пользователей

- **Гость:** брони, билеты, QR-пропуск
- **Промоутер:** создание списков, KPI
- **Host/Дверь:** сканирование QR, контроль входа
- **Менеджер:** управление залом, VIP
- **Маркетолог:** сегментации, рассылки
- **Администратор:** настройки системы

## 3. Архитектура

- Telegram Bot (Webhook)
- Telegram Mini App (React/Next.js)
- Backend API (REST/GraphQL)
- БД: PostgreSQL + Redis
- Очереди: Kafka/RabbitMQ
- Файлы: S3-совместимое хранилище
- Платежи: Telegram Payments API
- Админка: Next.js + RBAC

## 4. Основные потоки

### 4.1 Бронирование
1. Deep-link → Mini App
2. Выбор даты/стола/пакета
3. Оплата депозита
4. Генерация QR
5. Напоминания

### 4.2 Билеты
1. Каталог событий
2. Выбор билета
3. Оплата
4. Именной QR-билет

### 4.3 Waitlist
1. Запись при отсутствии мест
2. Авто-уведомления
3. Удержание места

### 4.4 Чек-ин
1. Сканирование QR
2. Проверка статуса
3. Отметка входа/отказа
4. Офлайн-режим с кешем

## 5. Промоутерский функционал

### 5.1 Управление гостями
- Добавление гостей
- Генерация реферальных ссылок
- Рассылка приглашений
- Отслеживание статусов

### 5.2 KPI и отчеты
- Количество приведенных
- Фактически пришедших
- Выручка
- Комиссии

## 6. CRM и маркетинг

- Профили гостей с историей
- VIP-уровни и теги
- Сегментация
- Автоматические кампании
- GDPR-совместимость

## 7. Платежи

- Telegram Bot Payments API
- Депозиты и билеты
- Возвраты и штрафы
- PCI-совместимость через провайдера

## 8. Безопасность

### Критические требования:
- **initData валидация** на сервере (обязательно!)
- Webhook секреты и IP allowlist
- Токены в переменных окружения
- TLS 1.2+, HSTS
- Шифрование PII в БД

## 9. Нефункциональные требования

- Производительность: 120 чек-инов/мин
- Доступность: 99.9%
- Масштабирование: горизонтальное
- Мониторинг: Prometheus/Grafana

## 10. План релизов

### Phase 1 (MVP, 8-10 недель):
- Bot + Mini App (Guest/Promoter/Door)
- Брони/билеты/депозиты
- Чек-ин с офлайн режимом
- Базовая CRM
- Админка
- Bot Payments

### Phase 2:
- POS-интеграции
- Расширенная аналитика
- Антифрод
- Мультивалютность
- Программы лояльности

## 11. Приемочные критерии MVP

✓ Гость может забронировать и оплатить через Mini App
✓ Промоутер управляет списками и видит KPI
✓ QR-чекин работает офлайн
✓ Waitlist автоматически заполняет отмены
✓ initData валидация реализована на сервере
✓ Админка позволяет управлять событиями и ролями
